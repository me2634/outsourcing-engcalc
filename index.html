<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/basic.css">
    <script src="js/jquery-1.12.4.min.js"></script>
    <script>

        function allowDrop(ev) {
            ev.preventDefault();
        }

        // 드래그 함수 처리
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);  // 이벤트 발생 태그 (드래그)
        }

        // 드롭 함수 처리
        function drop(ev) {
            ev.preventDefault();
            var c = ev.dataTransfer.getData("text");    // 드래그 시점에서 저장된 데이터 받기 (이미지ID)
            var targetId = ev.target.id;                // 이벤트 발생 태그 (드롭)
            var img = document.getElementById(c);       // img 태그

            if (targetId == 'funcExecArea') {

                var childNodes = document.getElementById("funcExec").childNodes;

                // 함수 놓는 곳은 1개만 허용
                if (childNodes.length > 0) {
                    return;
                }

                document.getElementById("funcExec").appendChild(img);
                img.onclick = function () {
                    eventHandler(img)
                };

            }
            else {

                initExe();  // 실행함수 초기화

                // 함수 놓는 곳 태그 삭제
                document.getElementById("funcArea").appendChild(img);


                var funcNode = document.getElementsByClassName("func");
                if (funcNode.length > 0) {
                    $(".func").remove();
                }

                // 함수 놓는 곳 -> 이벤트 삭제
                img.onclick = function () {
                };
            }
        }

        /*
           함수별 처리
         */
        function eventHandler(img) {

            var imgId = img.id;

            // 실행함수 지역 비우기
            initExe();

            // 삼각함수 이벤트 처리
            if (imgId == 'tri') {
                $(function () {
                    var triNode = document.getElementsByClassName("func");
                    if(triNode.length == 0){

                        // 삼각함수 펼치기
                        var triFunc = {};
                        triFunc.sin = '<div id="sin" class ="func">sin</div>';
                        triFunc.cos = '<div id="cos" class ="func">cos</div>';
                        triFunc.tan = '<div id="tan" class ="func">tan</div>';

                        $("#funcExec").append(triFunc.sin).append(triFunc.cos).append(triFunc.tan);

                        $.each(triFunc, function (key, value) {

                            // 각 하위 삼각함수에 이벤트 넣기
                            $("#"+key).on("click", function () {
                                initExe();
                                $("#selectFunc").append($('<div class="exe"></div>').append($(value).text()));
                            });
                        });
                    }
                });
            }
            // 상수 이벤트 처리
            else if (imgId === 'constant') {
                $(function () {
                    var triNode = document.getElementsByClassName("func");
                    if(triNode.length == 0){
                        var func = {};
                        func.pi = '<div id="pi" class ="func">pi</div>'; // pi
                        func.e = '<div id="e" class ="func">e</div>';    // 자연지수

                        $("#funcExec").append(func.pi).append(func.e);

                        $.each(func, function (key, value) {

                            $("#"+key).on("click", function () {
                                initExe();
                                $("#selectFunc").append($('<div class="exe"></div>').append($(value).text()));
                            });
                        });
                    }
                });
            }
            // 로그 이벤트 처리
            else if (imgId === 'log') {
                $("#selectFunc").append($('<div class="exe"></div>').append(imgId));
            }
            // 지수 이벤트 처리
            else if (imgId === 'exp') {
                $("#selectFunc").append($('<div class="exe"></div>').append(imgId));
            }
            // 루트 이벤트 처리
            else if (imgId === 'sqrt') {
                $("#selectFunc").append($('<div class="exe"></div>').append(imgId));
            }

        }

        // 실행함수 초기화 지우기!
        function initExe() {
            var exeNode =  document.getElementsByClassName("exe");
            if(exeNode.length > 0){
                $(".exe").remove();
            }
        }

        // 계산기 숫자, 기본연산자 이벤트처리
        $(function () {
            var $calcExe = $("#calcExe");


            // 숫자
            $("#calcTbl td, #operTbl td").on('click', function () {

                var textVal = this.innerText;

                // 함수가 있는 경우
                if (document.getElementsByClassName("exe").length > 0 && /[0-9]/.test(textVal)) {
                    textVal = funcCalculate(textVal);
                }

                // 수식 유효체크
                if (!'ce,Clear,result'.includes(textVal) && !validateCheck(textVal)) {
                    alert("다시 입력해주세요. 순서가 유효하지 않습니다.");
                    return;
                }

                // result 계산하기
                if (textVal === 'result') {
                    calculate($calcExe);
                    return;
                }


                // 0, 00 처음인 경우 text 초기화
                if((textVal !== '.' && $calcExe.text() === '0') || $calcExe.text() === '00' || (textVal === '.' && $calcExe.text().length == 0)){
                    if(textVal === '.'){
                        alert("소수점이 먼저 올 수 없습니다");
                        return;
                    }
                    $calcExe.text("");
                }

                // 백스페이스
                if (textVal === 'ce') {
                    $calcExe.text($calcExe.text().substring(0, $calcExe.text().length-1));
                    return;
                }
                // 클리어 -> 0으로 초기화
                if (textVal === 'Clear') {
                    $calcExe.text("").append('0');
                    return;
                }

                // 소수점 처리
                if (textVal === '.') {
                    alert("소수점임");
                }

                // 수식 붙이기
                $calcExe.append(textVal);
            });
        });

        // 함수 적용
        function funcCalculate(textVal) {
            var exeFunc = document.getElementsByClassName("exe")[0].innerHTML;
            if ('sin,cos,tan,log'.includes(exeFunc)) {
                return exeFunc + "(" + textVal + ")";
            }
            else if('exp' === exeFunc){
                return 'e'+'<sup class="supExp">'+textVal+'</sup>';
            }
            else if ('sqrt' === exeFunc) {
                return '&radic;'+textVal;
            }
            else if ('pi' === exeFunc) {
                return textVal + '&pi;';
            }
            else {
                return textVal + exeFunc;
            }
        }

        // 결과값 계산하기
        var count = 1;
        function calculate($calcExe) {

            // 결과 값 계산
            var result = 'ddd';
            var exeStr = $calcExe.html();

            // 수식 기호 간소화
            exeStr = exeStr.replace(/sin/gi,'s');
            exeStr = exeStr.replace(/cos/gi,'c');
            exeStr = exeStr.replace(/tan/gi,'t');
            exeStr = exeStr.replace(/log/gi,'l');
            exeStr = exeStr.replace(/π/gi,'p');
            exeStr = exeStr.replace(/√/gi,'r');
            exeStr = exeStr.replace(/<sup class="supExp">/gi,'');  // 지수
            exeStr = exeStr.replace(/<\/sup>/gi,'z');  // 지수
            exeStr = exeStr.replace(/\)/gi,'');
            exeStr = exeStr.replace(/\(/gi,'');

            var size = exeStr.length;
            var result = exeStr;

            // 함수 계산처리
            if(/.*[a-z].*/.test(exeStr)){
                var temp = "";
                for (var i = 0; i < size; i++) {
                    var ch = exeStr.charAt(i);

                    if (!isNaN(ch)) {
                        temp += ch;
                        continue;
                    }

                    if (ch === 's') {
                        // sin
                        result = exeStr.replace(temp+ch,Math.sin(parseInt(temp)));
                    }
                    else if (ch === 'c') {
                        // cos
                        result = exeStr.replace(temp+ch,Math.cos(parseInt(temp)));
                    }
                    else if (ch === 't') {
                        // tan
                        result = exeStr.replace(temp+ch,Math.tan(parseInt(temp)));
                    }
                    else if (ch === 'l') {
                        // log
                        result = exeStr.replace(temp+ch,Math.log(parseInt(temp)));
                    }
                    else if (ch === 'p') {
                        // pi
                        result = exeStr.replace(temp+ch, Math.PI * (parseInt(temp)));
                    }
                    else if (ch === 'r') {
                        // root
                    }
                    else if (ch === 'z') {
                        // exp
                        // result = exeStr.replace(temp+ch,Math.exp(parseInt(temp)));
                    }

                    temp = "";
                }
            }

            for (var i = 0; i < size; i++) {
                var ch = exeStr.charAt(i);
                if(isNaN(ch)){
                    // 함수형들 처리
                    console.log("문자 : ", ch);
                }else{
                    console.log("숫자 : ", ch);
                }
            }






            // 히스토리가 5개 이상인 경우 맨 앞 삭제
            if ($(".history").length >= 5) {
                $(".history:eq(0)").remove();
            }

            // 결과 붙일 히스토리 태그
            var appendHTML = '<div class="history">';
            appendHTML += (count++) + '. ';
            appendHTML += $calcExe.html();
            appendHTML += ' = ' + result;
            appendHTML += '</div>';
            $("#historyGround").append(appendHTML);

            // 결과 화면 초기화
            $("#calcExe").text('');
        }

        // 유효체크
        /*
            라스트 숫자 -> true
            라스트 연산자 / 인풋 연산자 -> false
            라스트 점   / 인풋 연산자 -> false
            라스트 점   / 인풋 숫자 -> true
         */
        function validateCheck(textVal) {

            var inputFlg = /[0-9]/.test(textVal);

            // 첫 입력 시점
            if ($("#calcExe").text().length == 0) {
                // 숫자 or exp이면 가능
                if(inputFlg || textVal.includes('sup')){
                    return true;
                }
                // 숫자가 아니면 안됨
                else{
                    return false;
                }
            }



            var lastCh = $("#calcExe").text().charAt($("#calcExe").text().length - 1);
            var lastFlg = /[0-9]/.test(lastCh);

            // 루트 and 마지막이 숫자이면 false
            if (lastFlg && textVal.includes('&radic;')) {
                return false;
            }

            // 지수함수
            if (textVal.includes('sup')) {
                if ($("#calcExe").text() === '0' || $("#calcExe").text() === '00') {
                    return true;
                }
                return lastFlg ? false : true;
            }

            if (lastFlg) {


                return true;
            }
            else{

                if (inputFlg) {
                    if ("),e".includes(lastCh) || 'π' == lastCh) {
                        return false;
                    }
                    // 인풋 숫자
                    return true;
                }
                else{
                    if ("),e".includes(lastCh) || 'π' == lastCh) {
                        return true;
                    }
                    return false;
                }

            }
        }


    </script>
</head>
<body>
<div class="container">
    <div class="boxUp">
        <div class="box box1" ondrop="drop(event)" ondragover="allowDrop(event)" id="funcExecArea">
            <h1> 함수 놓는 곳</h1>
            <div id="funcExec"></div>
        </div>
        <div class="box box2" id="calcGround">
            <h1 class="boxLabel" id="made">Made by jason</h1>
            <div id="selectFunc"></div>
            <div id="calcExe"></div>
        </div>
        <div class="box box3">
            <h1 class="boxLabel boxLabel2">배경색 바꾸기</h1>
            <h1 class="boxLabel boxLabel2">버튼색 바꾸기</h1>
            <h1 class="boxLabel boxLabel2">계산화면 글씨색 바꾸기</h1>
        </div>
    </div>
    <div class="boxDown">
        <div class="box box1 drop" ondrop="drop(event)" ondragover="allowDrop(event)" id="funcArea">
            <!-- 함수 -->
            <div>
                <img src="img/tri.png" draggable="true" ondragstart="drag(event)"  id="tri">
            </div>
            <div>
                <img src="img/exp.png" draggable="true" ondragstart="drag(event)" id="exp">
            </div>
            <div>
                <img src="img/log.png" draggable="true" ondragstart="drag(event)" id="log">
            </div>
            <div>
                <img src="img/sqrt.png" draggable="true" ondragstart="drag(event)" id="sqrt">
            </div>
            <div>
                <img src="img/constant.png" draggable="true" ondragstart="drag(event)" id="constant">
            </div>
        </div>

        <!-- 계산기 -->
        <div class="box box2">
            <table border="1" class="calcTbl" id="calcTbl">
                <tr>
                    <td>7</td>
                    <td>8</td>
                    <td>9</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>5</td>
                    <td>6</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>2</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>0</td>
                    <td>00</td>
                    <td>.</td>
                </tr>
            </table>
            <table border="1" class="operTbl" id="operTbl">
                <tr>
                    <td>+</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>x</td>
                    <td>%</td>
                </tr>
                <tr>
                    <td>/</td>
                    <td>ce</td>
                </tr>
                <tr>
                    <td>Clear</td>
                    <td>result</td>
                </tr>
            </table>
        </div>
        <div class="box box3">
            <h1 class="boxLabel">히스토리</h1>
            <div id="historyGround"></div>
        </div>
    </div>
</div>
</body>
</html>